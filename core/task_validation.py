"""\nTask Completion Validation\n\nEnforces evidence requirements for task completion.\nPrevents bulk-marking tasks complete without verification.\n"""\n\nfrom typing import Optional\nimport urllib.error\n\n# Task types that require completion evidence\nEVIDENCE_REQUIRED_TYPES = {\n    "code",\n    "deploy",\n    "test",\n    "review",\n    "migration"\n}\n\n# Examples of valid evidence by type\nEVIDENCE_EXAMPLES = {\n    "code": "Commit SHA | PR # | File paths modified",\n    "deploy": "Deployment ID | Service URL | Health check result",\n    "test": "Test run ID | Pass/fail count | Coverage %",\n    "review": "Review comment ID | Approval status",\n    "migration": "Migration ID | Rows affected | Rollback plan"\n}\n\n\ndef validate_completion_evidence(\n    task_type: str,\n    evidence: Optional[str]\n) -> tuple[bool, Optional[str]]:\n    """\n    Validate that completion evidence is provided for task types that require it.\n    \n    Args:\n        task_type: The type of task being completed\n        evidence: The completion evidence string\n    \n    Returns:\n        Tuple of (is_valid, error_message)\n        - is_valid: True if evidence is valid or not required\n        - error_message: None if valid, otherwise descriptive error\n    """\n    # Normalize task type\n    normalized_type = task_type.lower().strip() if task_type else ""\n    \n    # Check if this task type requires evidence\n    if normalized_type not in EVIDENCE_REQUIRED_TYPES:\n        return (True, None)  # No evidence required\n    \n    # Evidence is required - validate it\n    if not evidence or not evidence.strip():\n        example = EVIDENCE_EXAMPLES.get(normalized_type, "Specific evidence of completion")\n        return (\n            False,\n            f"Task type '{normalized_type}' requires completion evidence. "\n            f"Example: {example}"\n        )\n    \n    # Basic validation - evidence should be meaningful\n    if len(evidence.strip()) < 10:\n        return (\n            False,\n            "Completion evidence is too short. Please provide meaningful evidence "\n            "(at least 10 characters) such as commit SHA, log ID, or test results."\n        )\n    \n    return (True, None)\n\n\ndef complete_task_with_evidence(\n    task_id: str,\n    task_type: str,\n    evidence: str,\n    result: Optional[dict] = None\n) -> tuple[bool, Optional[str]]:\n    """\n    Complete a task with required evidence validation.\n    \n    Args:\n        task_id: UUID of the task to complete\n        task_type: Type of the task\n        evidence: Completion evidence string\n        result: Optional result dict\n    \n    Returns:\n        Tuple of (success, error_message)\n    """\n    from core.database import _db\n    import json\n    \n    # Validate evidence\n    is_valid, error = validate_completion_evidence(task_type, evidence)\n    if not is_valid:\n        return (False, error)\n    \n    # Use Database._format_value for proper SQL formatting (handles NULL, escaping)\n    evidence_sql = _db._format_value(evidence)\n    task_id_sql = _db._format_value(task_id)\n    \n    # Build result JSON if provided\n    result_sql = _db._format_value(result)\n    \n    # Update task with evidence\n    sql = f"""\n    UPDATE governance_tasks \n    SET status = 'completed',\n        completed_at = NOW(),\n        completion_evidence = {evidence_sql},\n        result = {result_sql}\n    WHERE id = {task_id_sql}\n      AND status = 'in_progress'\n    """\n    \n    try:\n        db_result = _db.query(sql)\n        if db_result.get("rowCount", 0) > 0:\n            return (True, None)\n        else:\n            return (False, "Task not found or not in 'in_progress' status")\n    except urllib.error.HTTPError as e:\n        return (False, f"HTTP error during database operation: {e.code} {e.reason}")\n    except urllib.error.URLError as e:\n        return (False, f"Network error during database operation: {e.reason}")\n\n\ndef get_evidence_requirements() -> dict[str, str]:\n    """\n    Get the list of task types that require evidence and examples.\n    \n    Returns:\n        Dict mapping task type to example evidence\n    """\n    return EVIDENCE_EXAMPLES.copy()\n